generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Material {
  id               String      @id @default(uuid())
  name             String
  category         String      @default("Stone")
  type             String
  purchasePrice    Float       @default(0)
  sellingPrice     Float?
  unit             String      @default("sqft")
  density          Float?
  wasteFactor      Float       @default(4)
  densityUnit      String      @default("lb/ft3")
  quality          String      @default("S")
  syncStatus       String      @default("DRAFT")
  validityDuration Int?
  sellingUnit      String      @default("sqft")
  imageUrl         String?
  supplierId       String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  supplier         ThirdParty? @relation(fields: [supplierId], references: [id])
  quotes           Quote[]
}

model ThirdParty {
  id                 String       @id @default(uuid())
  name               String
  type               String
  code               String?      @unique
  email              String?
  phone              String?
  fax                String?
  website            String?
  defaultCurrency    String       @default("CAD")
  paymentTerms       String?
  paymentTermId      String?
  paymentDays        Int          @default(0)
  depositPercentage  Float        @default(0)
  discountPercentage Float        @default(0)
  discountDays       Int          @default(0)
  paymentCustomText  String?
  supplierType       String?
  taxScheme          String?
  creditLimit        Float?
  repName            String?
  language           String       @default("fr")
  unitSystem         String       @default("Imperial")
  incoterm           String?
  incotermId         String?
  incotermCustomText String?
  priceListUrl       String?
  priceListDate      String?
  semiStandardRate   Float?
  salesCurrency      String?
  palletPrice        Float?
  palletRequired     Boolean?
  internalNotes      String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  exchangeRate       Float?
  validityDuration   Int?
  addresses          Address[]
  contacts           Contact[]
  materials          Material[]
  projects           Project[]
  quotes             Quote[]
  incotermRef        Incoterm?    @relation(fields: [incotermId], references: [id])
  paymentTerm        PaymentTerm? @relation(fields: [paymentTermId], references: [id])
}

model PaymentTerm {
  id                 String       @id @default(uuid())
  code               Int          @unique
  label_en           String
  label_fr           String
  days               Int          @default(0)
  depositPercentage  Float        @default(0)
  discountPercentage Float        @default(0)
  discountDays       Int          @default(0)
  requiresText       Boolean      @default(false)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  quotes             Quote[]
  clients            ThirdParty[]
}

model Contact {
  id           String     @id @default(uuid())
  firstName    String
  lastName     String
  email        String?
  phone        String?
  mobile       String?
  fax          String?
  role         String?
  thirdPartyId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  thirdParty   ThirdParty @relation(fields: [thirdPartyId], references: [id])
  quotes       Quote[]
  managedProjects WorkOrder[] @relation("ProjectManager")
  accountingWorkOrders WorkOrder[] @relation("AccountingContact")
}

model Address {
  id           String     @id @default(uuid())
  type         String
  line1        String
  line2        String?
  city         String
  state        String?
  zipCode      String?
  country      String
  thirdPartyId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  thirdParty   ThirdParty @relation(fields: [thirdPartyId], references: [id])
}

model ProjectLocation {
  id        String    @id @default(uuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  projects  Project[]
}

model Project {
  id             String           @id @default(uuid())
  name           String
  reference      String           @unique
  status         String
  thirdPartyId   String?
  locationId     String?
  measureSystem  String           @default("Imperial")
  estimatedWeeks Int?
  numberOfLines  Int?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  location       ProjectLocation? @relation(fields: [locationId], references: [id])
  client         ThirdParty?      @relation(fields: [thirdPartyId], references: [id])
  quotes         Quote[]
}

model Quote {
  id                 String       @id @default(uuid())
  reference          String       @unique
  version            Int          @default(1)
  currency           String       @default("CAD")
  exchangeRate       Float?       @default(1.0)
  incoterm           String?      @default("Ex Works")
  incotermId         String?
  incotermCustomText String?
  semiStandardRate   Float?
  salesCurrency      String?
  palletPrice        Float?
  palletRequired     Boolean?
  paymentTermId      String?
  paymentDays        Int?
  depositPercentage  Float?
  discountPercentage Float?
  paymentCustomText  String?
  status             String       @default("Draft")
  projectId          String
  thirdPartyId       String
  contactId          String?
  materialId         String?
  dateIssued         DateTime     @default(now())
  validUntil         DateTime?
  totalAmount        Float        @default(0)
  estimatedWeeks     Int?
  excelFilePath      String?
  pdfFilePath        String?
  syncStatus         String?
  odooId             String?
  odooStatus         String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  discountDays       Int?
  validityDuration   Int?
  material           Material?    @relation(fields: [materialId], references: [id])
  contact            Contact?     @relation(fields: [contactId], references: [id])
  client             ThirdParty   @relation(fields: [thirdPartyId], references: [id])
  project            Project      @relation(fields: [projectId], references: [id])
  paymentTerm        PaymentTerm? @relation(fields: [paymentTermId], references: [id])
  incotermRef        Incoterm?    @relation(fields: [incotermId], references: [id])
  representativeId   String?
  representative     Representative? @relation(fields: [representativeId], references: [id])
  items              QuoteItem[]
  workOrder          WorkOrder?
}

model WorkOrder {
  id              String   @id @default(uuid())
  reference       String   @unique // Format: BT25-0001
  status          String   @default("Open") // Open, Completed, Cancelled
  
  mepDate         DateTime @default(now()) // Mise en Production
  deadlineDate    DateTime? // A produire pour le (Calculated)
  deliveryDate    DateTime? // A livrer pour le
  clientRequiredDate DateTime? // Pour le (Requested by Client)

  productionWeeks Int?      // Délai Production (Semaines)
  note            String?   // Note textuelle (Entête)

  clientPO            String?   // Bon de commande client
  clientPOFilePath    String?   // Chemin du fichier uploadé
  projectManagerId    String?   // Responsable Projet (Contact)
  accountingContactId String?   // Responsable Compta (Contact)
  productionSiteId    String?   // Lieu de Production (NEW)

  projectManager      Contact?  @relation("ProjectManager", fields: [projectManagerId], references: [id])
  accountingContact   Contact?  @relation("AccountingContact", fields: [accountingContactId], references: [id])
  productionSite      ProductionSite? @relation(fields: [productionSiteId], references: [id])

  quoteId         String   @unique
  quote           Quote    @relation(fields: [quoteId], references: [id])
  pallets         Pallet[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Pallet {
  id          String       @id @default(uuid())
  number      Int          // 1, 2, 3...
  barcode     String?      // BT25-0001-P1
  status      String       @default("Open") // Open, Wrapped, Shipped
  workOrderId String
  workOrder   WorkOrder    @relation(fields: [workOrderId], references: [id])
  items       PalletItem[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model PalletItem {
  id          String    @id @default(uuid())
  palletId    String
  quoteItemId String
  quantity    Float     // Quantity put on this pallet
  
  pallet      Pallet    @relation(fields: [palletId], references: [id], onDelete: Cascade)
  quoteItem   QuoteItem @relation(fields: [quoteItemId], references: [id])
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model QuoteItem {
  id                  String          @id @default(uuid())
  quoteId             String
  tag                 String?
  lineNo              String?         // Added for XML "No" (NL)
  refReference        String?         // Added for XML "Ref" (REF)
  product             String?         // Added for XML "Item" (PDT)
  description         String
  material            String
  finish              String?
  unit                String?
  length              Float?
  width               Float?
  thickness           Float?
  quantity            Float           @default(1)
  numHoles            Int             @default(0)
  numSlots            Int             @default(0)
  netLength           Float           @default(0)
  netArea             Float           @default(0)
  netVolume           Float           @default(0)
  totalWeight         Float           @default(0)
  unitPrice           Float           @default(0)
  totalPrice          Float           @default(0)
  unitPriceInternal   Float           @default(0)
  totalPriceInternal  Float           @default(0)
  unitPriceCad        Float           @default(0)
  unitPriceUsd        Float           @default(0)
  totalPriceCad       Float           @default(0)
  totalPriceUsd       Float           @default(0)
  stoneValue          Float           @default(0)
  primarySawingCost   Float           @default(0)
  secondarySawingCost Float           @default(0)
  profilingCost       Float           @default(0)
  finishingCost       Float           @default(0)
  anchoringCost       Float           @default(0)
  unitTime            Float           @default(0)
  totalTime           Float           @default(0)
  productionStatus    String          @default("Pending")
  productionSiteId    String?
  productionNotes     String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  productionSite      ProductionSite? @relation(fields: [productionSiteId], references: [id])
  quote               Quote           @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  palletItems         PalletItem[]
}

model Setting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Representative {
  id        String   @id @default(uuid())
  firstName String
  lastName  String
  email     String?
  phone     String?
  mobile    String?
  fax       String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  quotes    Quote[]
}

model ContactType {
  id        String   @id @default(uuid())
  name      String
  category  String   @default("Client")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, category])
}

model Language {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductionSite {
  id        String      @id @default(uuid())
  name      String      @unique
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  items     QuoteItem[]
  workOrders WorkOrder[]

  // Address
  address   String?
  city      String?
  province  String?     @default("QC")
  zipCode   String?
  country   String?     @default("Canada")

  // Manager
  managerName  String?
  managerEmail String?
  managerPhone String?
}



model MaintenanceSite {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  equipments Equipment[]
  parts     Part[]
}



model Currency {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  symbol    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}



model EquipmentCategory {
  id        String      @id @default(uuid())
  name      String      @unique
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  equipments Equipment[]
}

model Equipment {
  id              String            @id @default(uuid())
  name            String
  internalId      String?           @unique // no.systeme (EQ-XXXX)
  serialNumber    String?           // no.equipement
  accountingCode  String?           // no.comptable
  brand           String?
  model           String?
  status          String            @default("Active")
  
  categoryId      String?
  category        EquipmentCategory? @relation(fields: [categoryId], references: [id])
  
  siteId          String?
  site            MaintenanceSite?   @relation(fields: [siteId], references: [id])
  
  supplier        String?           // Keeping as string for now based on data "fournisseur" column
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  repairs         RepairRequest[]
}




model PartCategory {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  parts     Part[]
}

model Part {
  id              String            @id @default(uuid())
  name            String
  reference       String?
  description     String?
  note            String?
  supplier        String?
  
  stockQuantity   Float             @default(0)
  minQuantity     Float             @default(0)
  reqQuantity     Float             @default(0)
  orderedQuantity Float             @default(0) // Qté. Com.
  
  categoryId      String?
  category        PartCategory?     @relation(fields: [categoryId], references: [id])
  
  siteId          String?
  site            MaintenanceSite?  @relation(fields: [siteId], references: [id])
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  repairParts     RepairPart[]
}




model RepairRequest {
  id           String     @id @default(uuid())
  reference    String?    @unique // Numéro de demande (ex: R-1024)
  equipmentId  String?
  equipment    Equipment? @relation(fields: [equipmentId], references: [id])
  
  title        String?
  description  String
  priority     String     @default("Normal")
  status       String     @default("Open")
  requester    String?
  mechanic     String?    // Mécanicien
  
  isMachineDown Boolean   @default(false) // Équipement fonctionnel (Non = true for isMachineDown, or false for isFunctional) 
  // Let's use isMachineDown for clarity: "Équipement à l'arrêt?" or stick to UI "isFunctional"
  // UI says "Équipement fonctionnel: Non / Oui". So isFunctional makes sense.
  isFunctional Boolean    @default(true)
  
  detectionDate DateTime? @default(now())
  dueDate      DateTime?  // A faire pour le
  closedAt     DateTime?  // Clôture réalisée le
  
  type         String     @default("Repair") // Repair, Maintenance
  recurrenceFreq String?  // Oneoff, Weekly, Monthly
  recurrenceDay  String?  // Monday, Tuesday... or 1st, 15th...

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  parts        RepairPart[] // Relation to RepairPart
}

model RepairPart {
  id              String        @id @default(uuid())
  repairRequestId String
  partId          String
  quantity        Float         @default(1)
  action          String        @default("USE") // USE, ORDER
  
  repairRequest   RepairRequest @relation(fields: [repairRequestId], references: [id], onDelete: Cascade)
  part            Part          @relation(fields: [partId], references: [id])
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}


model Incoterm {

  id           String       @id @default(uuid())
  name         String
  xmlCode      String
  requiresText Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  quotes       Quote[]
  clients      ThirdParty[]
}

model SystemConfig {
  id                        String   @id @default(uuid())
  key                       String   @unique @default("GLOBAL")
  defaultSemiStandardRate   Float    @default(0.4)
  defaultSalesCurrency      String   @default("CAD")
  defaultPalletPrice        Float    @default(50.0)
  defaultPalletRequired     Boolean  @default(false)
  defaultPaymentDays        Int      @default(30)
  defaultDepositPercentage  Float    @default(0)
  defaultDiscountPercentage Float    @default(0)
  defaultDiscountDays       Int      @default(10)
  defaultExchangeRate       Float    @default(1.0)
  defaultPaymentTermId      String?
  taxRateTPS                Float    @default(5.0)
  taxRateTVQ                Float    @default(9.975)
  taxRateTVH                Float    @default(13.0)
  taxRateTVH_Maritimes      Float    @default(15.0)
  defaultMeasureUnit        String   @default("an")
  defaultValidityDuration   Int      @default(30)
  updatedAt                 DateTime @updatedAt
}

model ExchangeRateHistory {
  id        String   @id @default(uuid())
  rate      Float
  date      DateTime @default(now()) // Can be set explicitly if we fetch historical data
  createdAt DateTime @default(now())
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hashed
  firstName String?
  lastName  String?
  role      String   @default("ADMIN") // ADMIN, USER, AGENT?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
